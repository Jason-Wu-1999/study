# redis的数据分布

Redis 集群没有使用一致性hash, 而是引入了 哈希槽的概念.

Redis 集群有16384个哈希槽,每个key通过CRC16校验后对16384取模来决定放置哪个槽.集群的每个节点负责一部分hash槽,举个例子,比如当前集群有3个节点,那么:

- 节点 A 包含 0 到 5500号哈希槽.
- 节点 B 包含5501 到 11000 号哈希槽.
- 节点 C 包含11001 到 16384号哈希槽.

**不一定要连续的**

### 数据迁移

数据迁移可以理解为slot(槽)和key的迁移，这个功能很重要，极大地方便了集群做线性扩展，以及实现平滑的扩容或缩容。

现在要将Master A节点中编号为1、2、3的slot迁移到Master B节点中，在slot迁移的中间状态下，slot 1、2、3在Master A节点的状态表现为MIGRATING（迁移）,在Master B节点的状态表现为IMPORTING（入口）。

==此时并不刷新node的映射关系==

IMPORTING状态

被迁移slot 在目标Master B节点中出现的一种状态，准备迁移slot从Mater A到Master B的时候，被迁移slot的状态首先变为IMPORTING状态。

### 虚拟槽分区的特点：

（1）解耦数据和节点之间的关系，简化了节点扩容和收缩的难度。

（2）==节点自身维护槽的映射关系==，不需要客户端或者代理服务维护槽分区元数据

（3）支持节点，槽，键之间的映射关系，用于数据路由、在线伸缩等场景。

## hash槽和一致性hash的对比

其实两者区分不大，使用hash槽的好处是可以做到==数据分配更均匀==，如果有N个节点，每个节点是准确的承担1/N的容量。而一致性hash做不到这点，因为它使用的是hash函数返回的值是随机的。而hash槽类似于我们准确配置每个节点的位置。
无论是hash槽还是一致性hash，本质上都是通过增加一层来解决依赖性问题。未使用时，key的分配依赖于节点个数，当节点个数变化时，key映射的节点也就改变了。增加了一个稳定层（hash槽），hash槽的个数是固定的，这样key分配到的hash槽也就是固定的。从而实现key与节点个数的解耦。hash槽与节点映射，当增加一个节点时，我们可以自己控制迁移哪些槽到新节点。

